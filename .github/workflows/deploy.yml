name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  SERVER_IP: 142.93.78.111
  DEPLOY_PATH: /var/www/nala-credit
  DOMAIN: admin.nalakreditimachann.com

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          # Decode base64 SSH key and write to file
          echo "${{ secrets.SSH_PRIVATE_KEY_BASE64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "Checking SSH key format..."
          head -1 ~/.ssh/deploy_key
          tail -1 ~/.ssh/deploy_key
          
          # Test SSH connection
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} 'echo "SSH connection successful!"'
      
      - name: ğŸ“‹ Display deployment info
        run: |
          echo "ğŸš€ Deploying to: ${{ env.SERVER_IP }}"
          echo "ğŸ“ Deploy path: ${{ env.DEPLOY_PATH }}"
          echo "ğŸŒ Domain: ${{ env.DOMAIN }}"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
      
      - name: ğŸ§¹ Prepare deployment files
        run: |
          # Create deployment package excluding unnecessary files
          tar czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='frontend-web/node_modules' \
            --exclude='backend/NalaCreditAPI/bin' \
            --exclude='backend/NalaCreditAPI/obj' \
            --exclude='*.md' \
            --exclude='*.sh' \
            --exclude='deploy.tar.gz' \
            .
      
      - name: ğŸ“¤ Upload code to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy.tar.gz root@${{ env.SERVER_IP }}:/tmp/
      
      - name: ğŸ”„ Deploy on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << 'ENDSSH'
            set -e
            
            echo "ğŸ“¦ Extracting new code..."
            cd ${{ env.DEPLOY_PATH }}
            
            # Backup current deployment
            BACKUP_DIR="/var/backups/nala-credit/deploy-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # Backup critical files
            if [ -f .env ]; then
              cp .env "$BACKUP_DIR/"
            fi
            if [ -f nginx.conf ]; then
              cp nginx.conf "$BACKUP_DIR/"
            fi
            
            echo "ğŸ’¾ Backup saved to: $BACKUP_DIR"
            
            # Extract new code
            tar xzf /tmp/deploy.tar.gz -C ${{ env.DEPLOY_PATH }}
            rm /tmp/deploy.tar.gz
            
            # Restore .env if it doesn't exist
            if [ ! -f .env ] && [ -f "$BACKUP_DIR/.env" ]; then
              cp "$BACKUP_DIR/.env" .env
            fi
            
            # Restore nginx.conf if it doesn't exist
            if [ ! -f nginx.conf ] && [ -f "$BACKUP_DIR/nginx.conf" ]; then
              cp "$BACKUP_DIR/nginx.conf" nginx.conf
            fi
            
            echo "ğŸ—ï¸  Building Docker images..."
            docker compose build --no-cache
            
            echo "ğŸ”„ Restarting services..."
            docker compose up -d
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "âœ… Deployment complete!"
            
            # Show status
            echo ""
            echo "ğŸ“Š Container Status:"
            docker compose ps
            
            echo ""
            echo "ğŸŒ Application available at:"
            echo "   https://${{ env.DOMAIN }}"
          ENDSSH
      
      - name: ğŸ§ª Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          
          # Wait a bit more for services to fully start
          sleep 15
          
          # Check HTTP redirect
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.DOMAIN }})
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" != "301" ] && [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ HTTP health check failed!"
            exit 1
          fi
          
          # Check HTTPS
          HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN }})
          echo "HTTPS Status: $HTTPS_STATUS"
          
          if [ "$HTTPS_STATUS" != "200" ]; then
            echo "âŒ HTTPS health check failed!"
            exit 1
          fi
          
          echo "âœ… All health checks passed!"
      
      - name: ğŸ”” Deployment summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "URL: https://${{ env.DOMAIN }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ğŸ’¬ Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details."
          # You can add Slack/Discord webhook notification here
