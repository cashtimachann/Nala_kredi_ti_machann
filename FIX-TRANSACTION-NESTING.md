# Fix: Transaction Nesting Error - Account Creation

## Problem
When creating a new savings account with an existing customer, the system was showing:
- First error: "Département invalide: Temp" (customer validation error)
- Second error: "The connection is already in a transaction and cannot participate in another transaction"

## Root Cause
**Transaction Nesting Conflict**: In `SavingsAccountService.OpenAccountAsync()`:
1. A database transaction was started: `using var transaction = await _context.Database.BeginTransactionAsync()`
2. The initial deposit was processed by calling `_transactionService.ProcessTransactionAsync()`
3. **Problem**: `ProcessTransactionAsync()` starts its own transaction internally
4. **Result**: Nested transaction error - EF Core doesn't support nested transactions on the same connection

## Solution
Modified `SavingsAccountService.OpenAccountAsync()` to create the initial deposit transaction **directly within the existing transaction** instead of calling `ProcessTransactionAsync()`.

### Changes Made
**File**: `backend/NalaCreditAPI/Services/SavingsAccountService.cs`

**Before** (lines 95-107):
```csharp
// 3. Effectuer le dépôt initial
var depositDto = new SavingsTransactionCreateDto
{
    AccountNumber = account.AccountNumber,
    Type = SavingsTransactionType.Deposit,
    Amount = dto.InitialDeposit,
    Description = "Dépôt initial d'ouverture",
    CustomerPresent = true,
    VerificationMethod = "Document d'identité vérifié"
};

await _transactionService.ProcessTransactionAsync(depositDto, userId);
```

**After** (lines 95-122):
```csharp
// 3. Effectuer le dépôt initial (dans la même transaction)
var initialDepositTransaction = new SavingsTransaction
{
    Id = Guid.NewGuid().ToString(),
    AccountId = account.Id,
    AccountNumber = account.AccountNumber,
    Type = SavingsTransactionType.Deposit,
    Amount = dto.InitialDeposit,
    Currency = account.Currency,
    BalanceBefore = 0,
    BalanceAfter = dto.InitialDeposit,
    Description = "Dépôt initial d'ouverture",
    Reference = $"DEP-{DateTime.UtcNow:yyyyMMdd}-{account.AccountNumber}",
    ProcessedBy = userId,
    BranchId = account.BranchId,
    Status = SavingsTransactionStatus.Completed,
    ProcessedAt = DateTime.UtcNow,
    CreatedAt = DateTime.UtcNow,
    VerificationMethod = "Document d'identité vérifié"
};

account.Balance = dto.InitialDeposit;
account.AvailableBalance = dto.InitialDeposit;
account.LastTransactionDate = DateTime.UtcNow;
account.UpdatedAt = DateTime.UtcNow;

_context.SavingsTransactions.Add(initialDepositTransaction);
await _context.SaveChangesAsync();
```

## Benefits
1. **No Nested Transactions**: All operations happen within a single transaction
2. **Better Performance**: Avoids transaction overhead
3. **Proper Atomicity**: All or nothing - if any step fails, everything rolls back
4. **Consistency**: Account balance and transaction record are always in sync

## Debug Logging Added
Also added debug logging to trace customer ID flow:
- `ClientAccountService.CreateAccountAsync`: Logs received `CustomerId`
- `SavingsAccountService.OpenAccountAsync`: Logs `ExistingCustomerId` check

## Testing
To test the fix:
1. Restart backend: `dotnet run` from `backend/NalaCreditAPI`
2. Login as SuperAdmin (superadmin@nalacredit.com)
3. Navigate to "Gestion de Comptes Clients"
4. Click "Créer un Nouveau Compte"
5. Enter an existing customer ID (e.g., search for a customer)
6. Fill in account details and submit
7. Should now create successfully without transaction errors

## Expected Behavior
✅ Account created with existing customer
✅ Initial deposit transaction recorded
✅ Account number auto-generated by backend (G########### or D###########)
✅ Success toast with account number displayed
✅ No transaction nesting errors

## Related Files
- `backend/NalaCreditAPI/Services/SavingsAccountService.cs` - Fixed transaction handling
- `backend/NalaCreditAPI/Services/ClientAccounts/ClientAccountService.cs` - Added debug logging
- `backend/NalaCreditAPI/Models/SavingsModels.cs` - SavingsTransaction model reference
